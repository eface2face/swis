<script src="swis.js"></script>
<script>
	var remoteCursor;
	var source;
	var transport = {
		onload : null,
		onmessage : null,
		send : function(data) {
			source.postMessage(data, "*");
		}
	};
	//Create iframe	
	var iframe = document.createElement("iframe");
	//Append it 
	document.documentElement.appendChild(iframe);
	//Get mirror
	var mirror = iframe.contentWindow.document;
		
	var reflector = new swis.Reflector(transport);
	
	window.addEventListener("message", function(message){
		//If first time
		if (!source)
		{
			//Start reflecting on mirror
			reflector.reflect(mirror);
			//Get source
			source = message.source;
		}
		//Init transport
		transport.onmessage(message.data);
	});
	
	//Create iframe	
	reflector.on("init",function(e) {
	});

	reflector.on("remotecursormove",function(data){
		//Check if first cursor
		if (!remoteCursor)
		{
			//Create new element
			remoteCursor = mirror.createElement("div");
			//Set absolute positioning
			remoteCursor.style["pointer-events"] = "none";
			remoteCursor.style["position"] = "absolute";
			remoteCursor.style["width"] = "150px";
			remoteCursor.style["height"] = "25px";
			remoteCursor.style["border"] = "1px black solid";
			remoteCursor.style["background-color"] = "green";
			remoteCursor.style["color"] = "white";
			remoteCursor.style["margin"] = "0px";
			remoteCursor.style["padding"] = "0px";
			remoteCursor.style["z-index"] = "99999999999999999999999999";
			//Set text
			remoteCursor.innerHTML = "^Remote Cursor";
			//Insert into
			mirror.documentElement.appendChild(remoteCursor);
		}
		//Set new position
		remoteCursor.style["left"] = data.x + "px";
		remoteCursor.style["top"] =  data.y + "px";
	});
	
	reflector.on("resize",function(data){
		iframe.width = data.width;
		iframe.height = data.height;
	});
	
	var selection = null;
	var highlights = [];
	
	function highlightSelection(){
		//Clean highligts first
		for (var i=0;i<highlights.length;i++)
			//REmove nodes
			highlights[i].remove();
		//Clean array
		highlights = [];
		
		//Get rects
		var rects = swis.Utils.getSelectionClientRects(document,selection);
			
		//Create a highlight for each rect
		for (var i=0;i<rects.length;i++)
		{
			//Create new element
			var high = document.createElement("div");
			//Set class
			high.className = "cursor";
			//Set absolute positioning
			high.style["pointer-events"] = "none";
			high.style["position"] = "absolute";
			high.style["top"] = rects[i].top+"px";
			high.style["left"] = rects[i].left+"px";
			high.style["width"] = rects[i].width+"px";
			high.style["height"] = rects[i].height+"px";
			high.style["border"] = "1px black solid";
			high.style["background-color"] = "yellow";
			high.style["margin"] = "0px";
			high.style["padding"] = "0px";
			high.style["opacity"] = "0.4";
			high.style["z-index"] = "2147483646";
			//Insert into
			document.documentElement.appendChild(high);
			//Push to highlights array
			highlights.push(high);
		}
	}
	
	reflector.on("remoteselectionchange",function(sel){
		console.log(selection);
		//Store new selection
		selection = sel;
		//Update
		highlightSelection();
	});
	
	window.addEventListener("resize",function(message){
		highlightSelection();
	});
</script>
