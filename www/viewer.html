<script>

	

	

	var source;
	var timer;
	var messages = [];
	
	function flush() {
		//POst message back to source
		source.postMessage(JSON.stringify(messages), "*");
		//clean queue
		messages = [];
		//Clear timer (jic)
		clearTimeout (timer);
		//Dismiss
		timer = null;
	}
	
	function queue(message) {
		console.log("queueing",message);
		//Add message to queue
		messages.push(message);
		//If not already scheduled
		if (!timer)
			timer = setTimeout(flush,20);
	}
	
	var transport = {
		onInit : null,
		onMessage : null,
		send : function(message) {
			queue(message);
		}
	};

	var inited = false;
	
	/*window.addEventListener("message", function(message){
		//Get source
		source = message.source;
		//Init transport
		transport.onInit(message.data);

		//Listen again fro new messages
		window.addEventListener("message", function(message){
			//Init transport
			transport.onMessages(JSON.parse(message.data));
		});
	});*/
	var ws = new WebSocket("wss://dev.ef2f.com/cobrowse/2");
	ws.binaryType = "arraybuffer";
	ws.onopen = function(){
		//Start reflecting DOM	
		reflect(transport,document);
	};	
	
	ws.onmessage = function(message) {
		//Check if first message
		if (!inited)
		{
			//Inited now
			inited = true;
			//Init transport
			transport.onInit(String.fromCharCode(message.data));
		} else {
			//Process messages
			transport.onMessages(JSON.parse(String.fromCharCode(message.data)));
		}
	}
</script>